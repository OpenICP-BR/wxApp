#include "CAStoreClass.h"

const char *icp_raiz_v1_pem = "-----BEGIN CERTIFICATE-----\nMIIEgDCCA2igAwIBAgIBATANBgkqhkiG9w0BAQUFADCBlzELMAkGA1UEBhMCQlIx\nEzARBgNVBAoTCklDUC1CcmFzaWwxPTA7BgNVBAsTNEluc3RpdHV0byBOYWNpb25h\nbCBkZSBUZWNub2xvZ2lhIGRhIEluZm9ybWFjYW8gLSBJVEkxNDAyBgNVBAMTK0F1\ndG9yaWRhZGUgQ2VydGlmaWNhZG9yYSBSYWl6IEJyYXNpbGVpcmEgdjEwHhcNMDgw\nNzI5MTkxNzEwWhcNMjEwNzI5MTkxNzEwWjCBlzELMAkGA1UEBhMCQlIxEzARBgNV\nBAoTCklDUC1CcmFzaWwxPTA7BgNVBAsTNEluc3RpdHV0byBOYWNpb25hbCBkZSBU\nZWNub2xvZ2lhIGRhIEluZm9ybWFjYW8gLSBJVEkxNDAyBgNVBAMTK0F1dG9yaWRh\nZGUgQ2VydGlmaWNhZG9yYSBSYWl6IEJyYXNpbGVpcmEgdjEwggEiMA0GCSqGSIb3\nDQEBAQUAA4IBDwAwggEKAoIBAQDOHOi+kzTOybHkVO4J9uykCIWgP8aKxnAwp4CM\n7T4BVAeMGSM7n7vHtIsgseL3QRYtXodmurAH3W/RPzzayFkznRWwn5LIVlRYijon\nojQem3i1t83lm+nALhKecHgH+o7yTMD45XJ8HqmpYANXJkfbg3bDzsgSu9H/766z\nYn2aoOS8bn0BLjRg3IfgX38FcFwwFSzCdaM/UANmI2Ys53R3eNtmF9/5Hw2CaI91\nh/fpMXpTT89YYrtAojTPwHCEUJcV2iBL6ftMQq0raI6j2a0FYv4IdMTowcyFE86t\nKDBQ3d7AgcFJsF4uJjjpYwQzd7WAds0qf/I8rF2TQjn0onNFAgMBAAGjgdQwgdEw\nTgYDVR0gBEcwRTBDBgVgTAEBADA6MDgGCCsGAQUFBwIBFixodHRwOi8vYWNyYWl6\nLmljcGJyYXNpbC5nb3YuYnIvRFBDYWNyYWl6LnBkZjA/BgNVHR8EODA2MDSgMqAw\nhi5odHRwOi8vYWNyYWl6LmljcGJyYXNpbC5nb3YuYnIvTENSYWNyYWl6djEuY3Js\nMB0GA1UdDgQWBBRCsixcdAEHvpv/VTM77im7XZG/BjAPBgNVHRMBAf8EBTADAQH/\nMA4GA1UdDwEB/wQEAwIBBjANBgkqhkiG9w0BAQUFAAOCAQEAWWyKdukZcVeD/qf0\neg+egdDPBxwMI+kkDVHLM+gqCcN6/w6jgIZgwXCX4MAKVd2kZUyPp0ewV7fzq8TD\nGeOY7A2wG1GRydkJ1ulqs+cMsLKSh/uOTRXsEhQZeAxi6hQ5GArFVdtThdx7KPoV\ncaPKdCWCD2cnNNeuUhMC+8XvmoAlpVKeOQ7tOvR4B1/VKHoKSvXQw2f3jFgXbwoA\noyYQtGAiOkpIpdrgqYTeQ9ufQ6c/KARHki/352R1IdJPgc6qPmQO4w6tVZp+lJs0\nwdCuaU4eo9mzh1facMJafYfN+b833u1WNfe3Ig5Pkrg/CN+cnphe8m+5+pss+M1F\n2HKyIA==\n-----END CERTIFICATE-----";

const char *icp_raiz_v2_pem = "-----BEGIN CERTIFICATE-----\nMIIGoTCCBImgAwIBAgIBATANBgkqhkiG9w0BAQ0FADCBlzELMAkGA1UEBhMCQlIx\nEzARBgNVBAoTCklDUC1CcmFzaWwxPTA7BgNVBAsTNEluc3RpdHV0byBOYWNpb25h\nbCBkZSBUZWNub2xvZ2lhIGRhIEluZm9ybWFjYW8gLSBJVEkxNDAyBgNVBAMTK0F1\ndG9yaWRhZGUgQ2VydGlmaWNhZG9yYSBSYWl6IEJyYXNpbGVpcmEgdjIwHhcNMTAw\nNjIxMTkwNDU3WhcNMjMwNjIxMTkwNDU3WjCBlzELMAkGA1UEBhMCQlIxEzARBgNV\nBAoTCklDUC1CcmFzaWwxPTA7BgNVBAsTNEluc3RpdHV0byBOYWNpb25hbCBkZSBU\nZWNub2xvZ2lhIGRhIEluZm9ybWFjYW8gLSBJVEkxNDAyBgNVBAMTK0F1dG9yaWRh\nZGUgQ2VydGlmaWNhZG9yYSBSYWl6IEJyYXNpbGVpcmEgdjIwggIiMA0GCSqGSIb3\nDQEBAQUAA4ICDwAwggIKAoICAQC6RqQO3edA8rWgfFKVV0X8bYTzhgHJhQOtmKvS\n8l4Fmcm7b2Jn/XdEuQMHPNIbAGLUcCxCg3lmq5lWroG8akm983QPYrfrWwdmlEIk\nnUasmkIYMPAkqFFB6quV8agrAnhptSknXpwuc8b+I6Xjps79bBtrAFTrAK1POkw8\n5wqIW9pemgtW5LVUOB3yCpNkTsNBklMgKs/8dG7U2zM4YuT+jkxYHPePKk3/xZLZ\nCVK9z3AAnWmaM2qIh0UhmRZRDTTfgr20aah8fNTd0/IVXEvFWBDqhRnLNiJYKnIM\nmpbeys8IUWG/tAUpBiuGkP7pTcMEBUfLz3bZf3Gmh3sVQOQzgHgHHaTyjptAO8ly\nUN9pvvAslh+QtdWudONltIwa6Wob+3JcxYJU6uBTB8TMEun33tcv1EgvRz8mYQSx\nEpoza7WGSxMr0IadR+1p+/yEEmb4VuUOimx2xGsaesKgWhLRI4lYAXwIWNoVjhXZ\nfn03tqRF9QOFzEf6i3lFuGZiM9MmSt4c6dR/5m0muTx9zQ8oCikPm91jq7mmRxqE\n14WkA2UGBEtSjYM0Qn8xjhEu5rNnlUB+l3pAAPkRbIM4WK0DM1umxMHFsKwNqQbw\npmkBNLbp+JRITz6mdQnsSsU74MlesDL/n2lZzzwwbw3OJ1fsWhto/+xPb3gyPnnF\ntF2VfwIDAQABo4H1MIHyME4GA1UdIARHMEUwQwYFYEwBAQAwOjA4BggrBgEFBQcC\nARYsaHR0cDovL2FjcmFpei5pY3BicmFzaWwuZ292LmJyL0RQQ2FjcmFpei5wZGYw\nPwYDVR0fBDgwNjA0oDKgMIYuaHR0cDovL2FjcmFpei5pY3BicmFzaWwuZ292LmJy\nL0xDUmFjcmFpenYyLmNybDAfBgNVHSMEGDAWgBQMOSA6twEfy9cofUGgx/pKrTIk\nvjAdBgNVHQ4EFgQUDDkgOrcBH8vXKH1BoMf6Sq0yJL4wDwYDVR0TAQH/BAUwAwEB\n/zAOBgNVHQ8BAf8EBAMCAQYwDQYJKoZIhvcNAQENBQADggIBAFmaFGkYbX0pQ3B9\ndpth33eOGnbkqdbLdqQWDEyUEsaQ0YEDxa0G2S1EvLIJdgmAOWcAGDRtBgrmtRBZ\nSLp1YPw/jh0YVXArnkuVrImrCncke2HEx5EmjkYTUTe2jCcK0w3wmisig4OzvYM1\nrZs8vHiDKTVhNvgRcTMgVGNTRQHYE1qEO9dmEyS3xEbFIthzJO4cExeWyCXoGx7P\n34VQbTzq91CeG5fep2vb1nPSz3xQwLCM5VMSeoY5rDVbZ8fq1PvRwl3qDpdzmK4p\nv+Q68wQ2UCzt3h7bhegdhAnu86aDM1tvR3lPSLX8uCYTq6qz9GER+0Vn8x0+bv4q\nSyZEGp+xouA82uDkBTp4rPuooU2/XSx3KZDNEx3vBijYtxTzW8jJnqd+MRKKeGLE\n0QW8BgJjBCsNid3kXFsygETUQuwq8/JAhzHVPuIKMgwUjdVybQvm/Y3kqPMFjXUX\nd5sKufqQkplliDJnQwWOLQsVuzXxYejZZ3ftFuXoAS1rND+Og7P36g9KHj41hJ2M\ngDQ/qZXow63EzZ7KFBYsGZ7kNou5uaNCJQc+w+XVaE+gZhyms7ZzHJAaP0C5GlZC\ncIf/by0PEf0e//eFMBUO4xcx7ieVzMnpmR6Xx21bB7UFaj3yRd+6gnkkcC6bgh9m\nqaVtJ8z2KqLRX4Vv4EadqtKlTlUO\n-----END CERTIFICATE-----";

const char *icp_raiz_v5_pem = "-----BEGIN CERTIFICATE-----\nMIIGoTCCBImgAwIBAgIBATANBgkqhkiG9w0BAQ0FADCBlzELMAkGA1UEBhMCQlIx\nEzARBgNVBAoMCklDUC1CcmFzaWwxPTA7BgNVBAsMNEluc3RpdHV0byBOYWNpb25h\nbCBkZSBUZWNub2xvZ2lhIGRhIEluZm9ybWFjYW8gLSBJVEkxNDAyBgNVBAMMK0F1\ndG9yaWRhZGUgQ2VydGlmaWNhZG9yYSBSYWl6IEJyYXNpbGVpcmEgdjUwHhcNMTYw\nMzAyMTMwMTM4WhcNMjkwMzAyMjM1OTM4WjCBlzELMAkGA1UEBhMCQlIxEzARBgNV\nBAoMCklDUC1CcmFzaWwxPTA7BgNVBAsMNEluc3RpdHV0byBOYWNpb25hbCBkZSBU\nZWNub2xvZ2lhIGRhIEluZm9ybWFjYW8gLSBJVEkxNDAyBgNVBAMMK0F1dG9yaWRh\nZGUgQ2VydGlmaWNhZG9yYSBSYWl6IEJyYXNpbGVpcmEgdjUwggIiMA0GCSqGSIb3\nDQEBAQUAA4ICDwAwggIKAoICAQD3LXgabUWsF+gUXw/6YODeF2XkqEyfk3VehdsI\nx+3/ERgdjCS/ouxYR0Epi2hdoMUVJDNf3XQfjAWXJyCoTneHYAl2McMdvoqtLB2i\nleQlJiis0fTtYTJayee9BAIdIrCor1Lc0vozXCpDtq5nTwhjIocaZtcuFsdrkl+n\nbfYxl5m7vjTkTMS6j8ffjmFzbNPDlJuV3Vy7AzapPVJrMl6UHPXCHMYMzl0KxR/4\n7S5XGgmLYkYt8bNCHA3fg07y+Gtvgu+SNhMPwWKIgwhYw+9vErOnavRhOimYo4M2\nAwNpNK0OKLI7Im5V094jFp4Ty+mlmfQH00k8nkSUEN+1TGGkhv16c2hukbx9iCfb\nmk7im2hGKjQA8eH64VPYoS2qdKbPbd3xDDHN2croYKpy2U2oQTVBSf9hC3o6fKo3\nzp0U3dNiw7ZgWKS9UwP31Q0gwgB1orZgLuF+LIppHYwxcTG/AovNWa4sTPukMiX2\nL+p7uIHExTZJJU4YoDacQh/mfbPIz3261He4YFmQ35sfw3eKHQSOLyiVfev/n0l/\nr308PijEd+d+Hz5RmqIzS8jYXZIeJxym4mEjE1fKpeP56Ea52LlIJ8ZqsJ3xzHWu\n3WkAVz4hMqrX6BPMGW2IxOuEUQyIaCBg1lI6QLiPMHvo2/J7gu4YfqRcH6i27W3H\nyzamEQIDAQABo4H1MIHyME4GA1UdIARHMEUwQwYFYEwBAQAwOjA4BggrBgEFBQcC\nARYsaHR0cDovL2FjcmFpei5pY3BicmFzaWwuZ292LmJyL0RQQ2FjcmFpei5wZGYw\nPwYDVR0fBDgwNjA0oDKgMIYuaHR0cDovL2FjcmFpei5pY3BicmFzaWwuZ292LmJy\nL0xDUmFjcmFpenY1LmNybDAfBgNVHSMEGDAWgBRpqL512cTvbOcTReRhbuVo+LZA\nXjAdBgNVHQ4EFgQUaai+ddnE72znE0XkYW7laPi2QF4wDwYDVR0TAQH/BAUwAwEB\n/zAOBgNVHQ8BAf8EBAMCAQYwDQYJKoZIhvcNAQENBQADggIBABRt2/JiWapef7o/\nplhR4PxymlMIp/JeZ5F0BZ1XafmYpl5g6pRokFrIRMFXLyEhlgo51I05InyCc9Td\n6UXjlsOASTc/LRavyjB/8NcQjlRYDh6xf7OdP05mFcT/0+6bYRtNgsnUbr10pfsK\n/UzyUvQWbumGS57hCZrAZOyd9MzukiF/azAa6JfoZk2nDkEudKOY8tRyTpMmDzN5\nfufPSC3v7tSJUqTqo5z7roN/FmckRzGAYyz5XulbOc5/UsAT/tk+KP/clbbqd/hh\nevmmdJclLr9qWZZcOgzuFU2YsgProtVu0fFNXGr6KK9fu44pOHajmMsTXK3X7r/P\nwh19kFRow5F3RQMUZC6Re0YLfXh+ypnUSCzA+uL4JPtHIGyvkbWiulkustpOKUSV\nwBPzvA2sQUOvqdbAR7C8jcHYFJMuK2HZFji7pxcWWab/NKsFcJ3sluDjmhizpQax\nbYTfAVXu3q8yd0su/BHHhBpteyHvYyyz0Eb9LUysR2cMtWvfPU6vnoPgYvOGO1Cz\niyGEsgKULkCH4o2Vgl1gQuKWO4V68rFW8a/jvq28sbY+y/Ao0I5ohpnBcQOAawiF\nbz6yJtObajYMuztDDP8oY656EuuJXBJhuKAJPI/7WDtgfV8ffOh/iQGQATVMtgDN\n0gv8bn5NdUX8UMNX1sHhU3H1UpoW\n-----END CERTIFICATE-----";

#ifdef USE_FAKE_ICP_ROOT
const char *icp_fake_raiz_pem = "-----BEGIN CERTIFICATE-----\nMIIFkjCCA3qgAwIBAgIJAK9aKx4ZqJ6IMA0GCSqGSIb3DQEBCwUAMFYxCzAJBgNV\nBAYTAkJSMQswCQYDVQQIDAJGTjENMAsGA1UEBwwESWxoYTEQMA4GA1UECgwHRmFr\nZVBLSTEZMBcGA1UEAwwQQ2hhdmUgUmHDg8KteiBWMTAeFw0xODA0MjkyMjI5MDha\nFw0zODA0MjQyMjI5MDhaMFYxCzAJBgNVBAYTAkJSMQswCQYDVQQIDAJGTjENMAsG\nA1UEBwwESWxoYTEQMA4GA1UECgwHRmFrZVBLSTEZMBcGA1UEAwwQQ2hhdmUgUmHD\ng8KteiBWMTCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIBAOKwN0DUAqib\n1s1XH1s1PfGGDCCWP5SQ0zRnRuuQFQI3MycNeNMkVJ1F7ntvGHeqUjLGoDiUNHC+\nnljuZkpN5evW/HVDcpZZm81f22QBp7rSuQ2zMn+BLLAD1LToxPlHDKfqTjOtACT8\nf3MjT0xYP90QJWYPsugpVJSt/EhKTa4J9wy8y1zT5NQY4f+sXN0FVNLa/lkgt01K\nXBcyJzGbNErNk135gD3lvcqsFrrovgjh244sUJo+OPjqcj7vOLQQKXxLGRylwoNB\n8lt81pWA6dXTAb7wFxfaurNYPHRG+jmiml3rt/hCIAieTza63PkPucqVz1qqoQD6\nU3P8IH+Wh2Q/+V72f3UahbTghXFCQfFl0BPaVqG0uxCQNO2quX6SP1J7VeN1WVJt\n1AO/orP2dloE8D74BoZrAkd9gOcCS6/rqmXkU9AA+7BGEWhweMXbMzGVoDKnM+x/\nLYfK1MAXS9zSHNH2+M7PHDyk/pbH5ecmJpTwSNk+pHJT0D8PiDhM3Hk3E3VNBNBB\nfSoukW/+4IdQhlOWBMddJTrQLhEtbplBqyd9YtY/AWZ4WmmJOtRNmgmwOSQaCIXi\nWcVYL7yP9iEGObg7z3wg4RmT7NCRDklAQsI2BE/mSValqjbMDXZDbTN/2zDDpKQL\nNNBxVnXveKCiSgKpxffDgoJ2fXZ2wL3vAgMBAAGjYzBhMB0GA1UdDgQWBBRz8j4v\ndZP5uVgoLB6uXBPS/fNbNzAfBgNVHSMEGDAWgBRz8j4vdZP5uVgoLB6uXBPS/fNb\nNzAPBgNVHRMBAf8EBTADAQH/MA4GA1UdDwEB/wQEAwIBhjANBgkqhkiG9w0BAQsF\nAAOCAgEA2vtZpCTZRjCo5i5HDRlZcTZ9v8q1/vTgTKc90M0kKGE+1Fcz703ZTaCC\nBAlxbzDuekvzj5Od8q2MuyqA9NpzFyxRUC2zyYwVR01UO9RL8ESJTAut7qXuJw+M\nVtpnx/X2ePRuRrC7coSsQA1GOwQf+5EqUtVhvRabr4iE99F9sFZEyazNlYTRaJ9X\nm2v1fD83G8wdqIK66J4L4qYwOVTLRjRDdRa5vXyrIVZfUdrF/eFop1i3//aDZ5YT\nybm2mGOPD6JnvecwoPhBWIpRbtJgr7K80drLqka8PBpIuFGO7idVmvfwq0fE6Yd1\nBKl98tv70VX6zO5Zb5Vjx2qHYXg+rSnxcI2lwneD0bPXHpi0+GCskCGg7/yIGLDq\nJ8DUDwLf9hhlST1RgNwVAze/RlOccvyCkD0WYxj4nwX8lhPgOUDLnKSmzCPZRIdp\nBpB2UJlpcTTbPRu4rv/beg0bgqHWadP/qLptHnMqdqKclJtGmY3fyRDv0V+QLUgE\nX0yrKYICPWnmrkRm2ztJL8Z9Pd+3+yxqQcG29ozLHilDtje7bu7e4PTDa819JfF4\nqUOB+wZqGGH067CaaA+PnMiyhWxHPmnDAYctjK59o2eXE0JMVkgOSHybcJ91Bcyb\nK6T7sNJW7mjtk8v2ZkG3yYpEV9QIWTs7aLSwBOO9YTQmCcszc4k=\n-----END CERTIFICATE-----";
#endif

CAStoreClass::CAStoreClass() {
	// Create X509_STORE_CTX
	store = X509_STORE_new();
	if (store == NULL) {
		cout << "Failed to create X509_STORE_CTX." << endl;
	}

	// Add root certificates
	addCA(PEM2X509(icp_raiz_v1_pem));
	addCA(PEM2X509(icp_raiz_v2_pem));
	addCA(PEM2X509(icp_raiz_v5_pem));
	#ifdef USE_FAKE_ICP_ROOT
	addCA(PEM2X509(icp_fake_raiz_pem));
	#endif
}

bool CAStoreClass::addCA(X509 *cert) {
	if (cert == NULL) {
		return false;
	}
	if (X509_STORE_add_cert(store, cert) == 0) {
		return false;
	}

	X509_NAME *xname;
	char buf[999];

	xname = X509_get_subject_name(cert);
	X509_NAME_oneline(xname, buf, 999);
	printf("Added CA: %s\n", buf);

	return true;
}

bool CAStoreClass::AddCA_PEM(const char data[]) {
	return AddCA(PEM2X509(data));
}

bool CAStoreClass::AddCA(X509 *cert) {
	X509_STORE_CTX *ctx = X509_STORE_CTX_new();
	if (ctx == NULL) {
		cout << "Failed to create X509_STORE_CTX" << endl;
		return false;
	}
	if (X509_STORE_CTX_init(ctx, store, cert, NULL) != 1) {
		cout << "Failed to initialize X509_STORE_CTX" << endl;
		X509_STORE_CTX_free(ctx);
		return false;
	}
	int rc = X509_verify_cert(ctx);
	X509_STORE_CTX_free(ctx);

	if (rc == 1) {
		return addCA(cert);
	}
	return false;
}

CAStoreClass::~CAStoreClass() {
	X509_STORE_free(store);
}